# AWS Elastic Beanstalk Node.js Configuration
# This file configures the Node.js environment for AION backend

option_settings:

  # Environment Properties
  aws:elasticbeanstalk:application:environment:
    PORT: "5000"
    NODE_ENV: "production"
    NPM_USE_PRODUCTION: "true"

  # Instance Settings  
  aws:autoscaling:launchconfiguration:
    InstanceType: t3.small
    IamInstanceProfile: aws-elasticbeanstalk-ec2-role
    
  # Auto Scaling
  aws:autoscaling:asg:
    MinSize: 1
    MaxSize: 4
    Cooldown: 360

  aws:autoscaling:trigger:
    MeasureName: CPUUtilization
    Statistic: Average
    Unit: Percent
    UpperThreshold: 75
    UpperBreachScaleIncrement: 1
    LowerThreshold: 30
    LowerBreachScaleIncrement: -1

  # Load Balancer
  aws:elasticbeanstalk:environment:
    LoadBalancerType: application
    ServiceRole: aws-elasticbeanstalk-service-role

  aws:elbv2:listener:443:
    Protocol: HTTPS
    SSLCertificateArns: arn:aws:acm:us-east-1:ACCOUNT_ID:certificate/CERT_ID

  aws:elbv2:listener:80:
    Protocol: HTTP
    ListenerEnabled: true

  # Health Check
  aws:elasticbeanstalk:environment:process:default:
    HealthCheckPath: /health
    HealthCheckInterval: 30
    HealthCheckTimeout: 5
    HealthyThresholdCount: 2
    UnhealthyThresholdCount: 3
    Port: 5000
    Protocol: HTTP
    StickinessEnabled: false

  # CloudWatch Logs
  aws:elasticbeanstalk:cloudwatch:logs:
    StreamLogs: true
    DeleteOnTerminate: false
    RetentionInDays: 7

  aws:elasticbeanstalk:cloudwatch:logs:health:
    HealthStreamingEnabled: true
    DeleteOnTerminate: false
    RetentionInDays: 7

  # VPC (Optional - Configure if needed)
  # aws:ec2:vpc:
  #   VPCId: vpc-xxxxx
  #   Subnets: subnet-xxxxx,subnet-yyyyy
  #   ELBSubnets: subnet-xxxxx,subnet-yyyyy

  # Environment Variables (Sensitive - Configure via EB Console)
  # OPENAI_API_KEY: Configure in EB Console
  # MONGODB_URI: Configure in EB Console
  # FRONTEND_URL: https://rajora.co.in

  # Managed Updates
  aws:elasticbeanstalk:managedactions:
    ManagedActionsEnabled: true
    PreferredStartTime: "Sun:03:00"

  aws:elasticbeanstalk:managedactions:platformupdate:
    UpdateLevel: minor
    InstanceRefreshEnabled: true

  # Notifications (Optional)
  # aws:elasticbeanstalk:sns:topics:
  #   Notification Endpoint: your-email@example.com
  #   Notification Protocol: email

packages:
  yum:
    git: []
    gcc-c++: []
    make: []

files:
  "/etc/nginx/conf.d/proxy.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      client_max_body_size 20M;
      proxy_connect_timeout 300;
      proxy_send_timeout 300;
      proxy_read_timeout 300;
      send_timeout 300;

container_commands:
  01_node_version:
    command: "node --version"
  02_npm_version:
    command: "npm --version"
  03_install_dependencies:
    command: "npm ci --production"
    cwd: /var/app/staging
  04_create_log_dir:
    command: "mkdir -p /var/log/aion && chmod 777 /var/log/aion"
